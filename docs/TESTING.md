# Template4 Smoke-tests

These validate the proper operation of the Template-engine.

Note that these are **smoke tests**, not fully-fledged unit-tests. The tests
compare a set of predefined inputs against a set of predefined outputs. In doing
so they will (most likely) identify any issues with the Template-engine...

- [Relation to template4-parser](#relation-to-template4-parser)
- [The Tests](#the-tests)
- [Updating the "Expected" outcomes](#updating-the-expected-outcomes)

## Relation to template4-parser

The template used to validate the Javascript-based
[template4-parser](https://github.com/studyportals/template4-parser) is nearly
identical to the one used as a smoke-test for Template4 here.

The main difference is that in some places an updated/simplified syntax (made
possible by the Jison-based parser-generator) is used that is _not_
backwards-compatible with the PHP implementation in this repository.

See the
[Differences with PHP-based implementation](https://github.com/studyportals/template4-parser#differences-with-php-based-implementation)-section
for more details.

## The Tests

There are three tests:

1. tokenisation
2. caching
3. rendering

The tests are executed in the order listed above. Each test relies on the
previous test(s); i.e. a failure of test 1 implies the failure of test 2 and 3.
They are split up in multiple steps to aid locating the point of failure.

**Tokenisation** ensures the input template-file is properly parsed into a set
of tokens. This effectively validates that the template-grammar is still
properly parsed by the Template-engine.

**Caching** ensures the cached representation of the template (a serialised
PHP-object) still matches with what is produced by the Template-engine. This
validates the Template-engine is able to build a proper object-model out of the
parsed template.

**Rendering** ensures the HTML generated by the Template-engine matches with a
reference HTML-file. This validates the template "runtime" (passing in
variables, repeating elements, etc.) still works as intended.

## Updating the "Expected" outcomes

When either the Template-grammar or the inputs for the tests (in
[`ðŸ“‚ Resources`](./../tests/smoke/Resources/)) are updated, the expected
outcomes (in [`ðŸ“‚ Expected`](./../tests/smoke/Expected/)) should be updated to
match.

The easiest way to do this is to open an interactive PHP shell (`php -a`) and
execute the following:

```php
require(__DIR__ . '/vendor/autoload.php');
\StudyPortals\Template\Tests\Smoke\TemplateTest::renderExpected();
```

After executing this, the outcomes in
[`ðŸ“‚ Resources`](./../tests/smoke/Resources/) are updated to match the resources
in [`ðŸ“‚ Expected`](./../tests/smoke/Expected/) under the current state of the
Template-engine.

âš  You need to _manually_ inspect the outcomes to ensure the Template-engine
still performs as intended. In most cases, inspecting the rendered output (see
[ðŸ“„ Expected/Render.html](../tests/smoke/Expected/Render.html)) should be
sufficient.

Once you're satisfied that the Template-engine is performing as intended, you
can commit the contents of the
[`ðŸ“‚ Expected`-folder](./../tests/smoke/Expected/) to Git.
